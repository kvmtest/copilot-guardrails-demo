name: Enterprise Guardrails
on: 
  pull_request:
    types: [opened, synchronize]

jobs:
  guardrails-check:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Hybrid Analysis Engine
        uses: actions/github-script@v7
        env:
          # ADD THIS SECRET IN GITHUB SETTINGS -> SECRETS -> ACTIONS
          API_URL: ${{ secrets.GUARDRAILS_URL }} 
        with:
          script: |
            const diff = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              mediaType: { format: 'diff' }
            });

            console.log("ðŸš€ Sending Code to Enterprise Engine...");
            
            // Call Python Backend
            const response = await fetch(`${process.env.API_URL}/scan`, {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({
                diff: diff.data,
                commit_messages: context.payload.pull_request.title,
                industry: "Banking" // Configurable Rule Pack
              })
            });
            
            const result = await response.json();
            
            // Post Comments
            const comments = result.issues.map(issue => ({
              path: "app.py", // Simplified for demo, theoretically parses file path
              line: issue.line || 1,
              body: `ðŸ›¡ï¸ **Guardrails Alert** [${issue.severity}]\n\n${issue.message}\n\n*Suggestion: ${issue.suggestion}*`
            }));
            
            // If we have valid line numbers, post review. 
            // Note: For demo, we might just post a general comment if line mapping is tricky
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: `## ðŸ›¡ï¸ Guardrails Report\n\n**AI Detection:** ${result.is_ai ? 'ðŸ¤– Likely AI-Generated' : 'ðŸ‘¤ Likely Human'}\n**Status:** Found ${result.issues.length} violations.`
            });

            // BLOCK THE MERGE for Critical Issues
            const blockers = result.issues.filter(i => i.severity === 'BLOCKING' || i.severity === 'CRITICAL');
            if (blockers.length > 0) {
                core.setFailed(`â›” BLOCKED: Found ${blockers.length} Critical/Blocking violations. Compliance required.`);
            }
